/*! dmv - v0.2.0 - 2/29/2012
* https://github.com/rwldrn/dmv
* Copyright (c) 2012 Rick Waldron <waldron.rick@gmail.com>; Licensed MIT */
(function(a){var b=a.navigator,c=function(a){var c=b.getUserMedia||b.webkitGetUserMedia,d=b.getUserMedia?{video:!0,audio:!0}:"video,audio";c.call(b,d,function(b){var c=window.webkitURL?window.webkitURL.createObjectURL(b):b;a(c)})},d,e;d=function(a,b){var e=localStorage.getItem("dmv-id");e||(e=d.id(),localStorage.setItem("dmv-id",e)),this.id=e,this.container=document.querySelector(a),this.media=this.fixture("video",this.id),this.canvas=this.fixture("canvas",this.id),this.context=this.canvas.getContext("2d"),this.socket=b,this.dataUri="",c(function(a){this.media.src=a,this.media.addEventListener("loadedmetadata",function(){this.media.play()}.bind(this),!1),this.media.addEventListener("timeupdate",function(){this.draw()}.bind(this),!1)}.bind(this))},d.prototype.draw=function(){this.context.drawImage(this.media,0,0,this.canvas.width,this.canvas.height)},d.prototype.capture=function(){var a=this.canvas.toDataURL();this.socket.emit("capture",{id:this.id,captured:this.canvas.toDataURL()})},d.prototype.fixture=function(a,b){var c=document.createElement(a),d;return c.id=a[0]+"_"+b,c.style.width=window.innerWidth+"px",this.container||(this.container=document.body),a==="canvas"&&(d=document.querySelector("video[id$='"+b+"']"),setTimeout(function e(){d.videoWidth>0?(c.width=d.videoWidth,c.height=d.videoHeight,c.style.visibility="hidden"):setTimeout(e,10)},10)),this.container.appendChild(c),c},d.id=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a==="x"?b:b&3|8).toString(16)}).toUpperCase()},e={socket:null,operator:null,init:function(a,b){e.socket=b,e.operator=new d(a,b),this.listen(e.operator.media)},listen:function(a){a.addEventListener("click",e.operator.capture.bind(e.operator),!1)}},a.DMV=e,a.Operator=d})(typeof exports=="object"&&exports||this)